# OpenAMP RemoteProc

This extension is still a DRAFT.


OpenAMP RemoteProc is a framework for remote processor communication and
lifecycle management between Linux and other OSes.

Lopper, the tool to parse system device tree and generate one or more
traditional device trees for target domains, can generate OpenAMP
RemoteProc nodes for Linux and other Operating Systems starting from the
System Device Tree representation of the same information.

Lopper comes with plugins and one of them is to generate the Xilinx
RemoteProc device tree nodes. Other silicon vendors can introduce
similar plugins to generate their RemoteProc device tree nodes.



## System Device Tree

At the System Device Tree level, no special nodes or properties are
needed to represent RemoteProc information. Typically, the main cluster
and the remote cluster are separate domains. Any shared resources are
represented as a resource-group, as usual with system device tree.

Special vendor-specific properties can be represented using the access
list flag fields, as usual with system device tree.



### System Device Tree Example

This is a System Device Tree example that can be used as input for
lopper to generate RemoteProc nodes for Linux.

The things to note are:

- resource\_group@0 to share resources
- the 0x13 access flags for ipi\_mailbox\_rpu0, the specific
  meaning is expressed in a comment below
- the sharedmem flag, which is defined as 0x1 for openamp_a53, which
  means master, and as 0x0 for openamp_r5, which means slave.


~~~
	psu_r5_0_atcm_global: psu_tcm_global@ffe00000 {
		xlnx,s-axi-highaddr = <0xFFE0FFFF>;
		compatible = "xlnx,psu-tcm-global";
		status = "okay";
		reg = <0x0 0xffe00000 0x0 0x10000>;
		firewall-0 = <&lpd_xppu>;
		xlnx,s-axi-baseaddr = <0xFFE00000>;
	};
	psu_r5_0_btcm_global: psu_tcm_global@ffe20000 {
		xlnx,s-axi-highaddr = <0xFFE2FFFF>;
		compatible = "xlnx,psu-tcm-global";
		status = "okay";
		reg = <0x0 0xffe20000 0x0 0x10000>;
		firewall-0 = <&lpd_xppu>;
		xlnx,s-axi-baseaddr = <0xFFE20000>;
	};

	zynqmp_ipi@0 {
		 compatible = "xlnx,zynqmp-ipi-mailbox";
		 interrupt-parent = <&gic>;
		 interrupts = <0 29 4>;
		 xlnx,ipi-id = <7>;
		 #address-cells = <1>;
		 #size-cells = <1>;
		 ranges;

		 /* APU<->RPU0 IPI mailbox controller */
		 ipi_mailbox_rpu0: mailbox@ff90000 {
			reg = <0xff990600 0x20>,
			      <0xff990620 0x20>,
			      <0xff9900c0 0x20>,
			      <0xff9900e0 0x20>;
			reg-names = "local_request_region",
				    "local_response_region",
				    "remote_request_region",
				    "remote_response_region";
			#mbox-cells = <1>;
			xlnx,ipi-id = <1>;
		 };
	};

	domains {
		#address-cells = <0x2>;
		#size-cells = <0x2>;

		resource_group: resource_group@0 {
			compatible = "openamp,remoteproc-v1", "openamp,group-v1";
			memory = <0x0 0x3ed40000 0x0 0x4000
				  0x0 0x3ed44000 0x0 0x4000
				  0x0 0x3ed48000 0x0 0x100000
				  0x0 0x3ed00000 0x0 0x40000
			memory-flags-names = "sharedmem";
			sram = <&psu_r5_0_btcm_global>, <&psu_r5_0_atcm_global>;
			sram-flags-names = "sharedmem";
		};

		openamp_a53 {
			compatible = "openamp,domain-v1";
			#address-cells = <0x2>;
			#size-cells = <0x2>;

			id = <0x3>;
			memory = <0x0 0x80000000 0x0 0x78000000
				  0x8 0x0 0x0 0x80000000>;
			cpus = <&cpus_a53 0xf 0x2>;

			/*
			 * Flags field, mapping specific
			 *
			 * memory and reserved-memory:
			 *   bit 0: 0/1: RO/RW
			 *
			 * xlnx,zynqmp-ipi-mailbox:
			 *   4 bits for each IPI channel to pass special flags
			 *   0-3   bits: channel 0
			 *   4-7   bits: channel 1
			 *   8-11  bits: channel 2
			 *   12-15 bits: channel 3
			 * each 4 bits:
			 *   bit 0: enable/disable (enable==1)
			 *   bit 1: TX/RX (TX==1)
			 *   bit 2-3: unused
			 *
			 * Other cases: unused 
			 *
			 */
			#flags-cells = <1>;
			flags = <0x13 0x1>;
			flags-names = "rpu0", "sharedmem";
			access = <&ipi_mailbox_rpu0>;
			access-flags-names = "rpu0";

			include = <&resource_group>;
		};

		openamp_r5 {
			compatible = "openamp,domain-v1";
			#address-cells = <0x2>;
			#size-cells = <0x2>;

			id = <0x4>;
			memory = <0x0 0x0 0x0 0x20000000>;
			cpus = <&cpus_r5 0x2 0x80000000>;

			#flags-cells = <1>;
			flags = <0x0>;
			flags-names = "sharedmem";

			include = <&resource_group>;
		};
	};
~~~


### Device Tree Conversion and Example

The corresponding Device Tree for Linux generated by lopper is the
following. (It is compliant to the latest RemoteProc Xilinx bindings
upstream.)

- the reserved-memory regions are generated from the regions under resource\_group@0 in system device tree
- r5ss@f9a00000:
    - xlnx,cluster-mode comes from the cpus property of the RPU domain
    - memory-region and sram properties come from resource\_group@0
	- mboxes and mbox-names come from the access property and the 0x13 flag

~~~
	reserved-memory {
		#address-cells = <1>;
		#size-cells = <1>;
		ranges;

		rpu0vdev0vring0: rpu0vdev0vring0@3ed40000 {
			compatible = "xilinx,openamp-ipc-1.0";
			no-map;
			reg = <0x3ed40000 0x4000>;
		};
		rpu0vdev0vring1: rpu0vdev0vring1@3ed44000 {
			compatible = "xilinx,openamp-ipc-1.0";
			no-map;
			reg = <0x3ed44000 0x4000>;
		};
		rpu0vdev0buffer: rpu0vdev0buffer@3ed48000 {
			compatible = "xilinx,openamp-ipc-1.0";
			no-map;
			reg = <0x3ed48000 0x100000>;
		};
		rproc_0_reserved: rproc@3ed000000 {
			compatible = "xilinx,openamp-ipc-1.0";
			no-map;
			reg = <0x3ed00000 0x40000>;
		};
	};

	r5ss@f9a00000 {
		compatible = "xlnx,zynqmp-r5-remoteproc";
		#address-cells = <2>;
		#size-cells = <2>;
		ranges;
		reg = <0x0 0xff9a0000 0x0 0x10000>;
		xlnx,cluster-mode = <0>;

		r5f_0 {
			compatible = "xilinx,r5f";
			memory-region = <&elf_load0>,
							 <&rpu0vdev0vring0>,
							 <&rpu0vdev0vring1>,
							 <&rpu0vdev0buffer>;
			sram = <&psu_r5_0_atcm_global>, <&psu_r5_0_btcm_global>;
			mboxes = <&ipi_mailbox_rpu0 0x0 &ipi_mailbox_rpu0 0x1>;
			mbox-names = "tx", "rx";
			power-domain = <0x7>;
		};
	};

	psu_r5_0_atcm_global: psu_tcm_global@ffe00000 {
		compatible = "xlnx,psu-tcm-global";
		status = "okay";
		reg = <0x0 0xffe00000 0x0 0x10000>;
	};
	psu_r5_0_btcm_global: psu_tcm_global@ffe20000 {
		compatible = "xlnx,psu-tcm-global";
		status = "okay";
		reg = <0x0 0xffe20000 0x0 0x10000>;
	};

	zynqmp_ipi@0 {
		compatible = "xlnx,zynqmp-ipi-mailbox";
		interrupt-parent = <&gic>;
		interrupts = <0 29 4>;
		xlnx,ipi-id = <7>;
		#address-cells = <1>;
		#size-cells = <1>;
		ranges;

		 /* APU<->RPU0 IPI mailbox controller */
		 ipi_mailbox_rpu0: mailbox@ff90000 {
			reg = <0xff990600 0x20>,
			      <0xff990620 0x20>,
			      <0xff9900c0 0x20>,
			      <0xff9900e0 0x20>;
			reg-names = "local_request_region",
				    "local_response_region",
				    "remote_request_region",
				    "remote_response_region";
			#mbox-cells = <1>;
			xlnx,ipi-id = <1>;
		 };
	};
~~~
